<!DOCTYPE html>
<html>
    <head>
        <title>Nerdle</title>
        <style>
            body{
                width:max-content;
                overflow-x: hidden;
            }
            table{
                color:black;
                border:1px solid black;
                border-spacing:0;
                text-align:center;
                background-color:rgb(240, 248, 255);
                font-size:25px;
                font-family:"Segoe UI";
                margin: 50px auto;
            }
            td{
                height:50px;
                width:50px;
                padding:0;
                border:1px solid black;
                cursor:pointer;
            }
            #inputs{
                margin: auto;
            }
            td:hover{
                background-color:rgb(220, 228, 235);
            }
            .inputButton {
                border: 1px solid black;
                border-radius: 2px;
            }
            p{
                width: 100vw;
            }
            .elim{
                background-color: gray;
            }
        </style>
        <script>
            let possibleAnswers = ["8*3-5=19","37*4=148","7*8/4=14","42/3/2=7","9/3+7=10","91/7-6=7","51/3-8=9","125/25=5","225/15=15","147/21=7","1+3+5=9","8*3-5=19","20*2+5=45","198/3+4=70","34*11+9=363"]
            let cells=[], selectedCell="00", attempts = 1, eqLen = 1, currentAttempt = 1, currentAnswerId = 0, gameOver = false;
            let defColor = "rgb(240, 248, 255)";
            
            function pageLoad(){
                setup(6,8);
            }

            function setup(att=6, len=0){
                document.getElementById("reset").blur();
                selectedCell = "00", attempts = att, currentAttempt = 1, cells=[];
                if (len==0){
                    currentAnswerId = Math.floor(Math.random()*possibleAnswers.length)%possibleAnswers.length;
                    eqLen = possibleAnswers[currentAnswerId].length;
                } else {
                    eqLen = len;
                    currentAnswerId = Math.floor(Math.random()*possibleAnswers.length)%possibleAnswers.length;
                    while (possibleAnswers[currentAnswerId].length!=len){
                        currentAnswerId = Math.floor(Math.random()*possibleAnswers.length)%possibleAnswers.length;
                    }
                }
                document.getElementById("board").innerHTML="";
                for (let i=0; i<attempts; i++){
                    document.getElementById("board").innerHTML+=`<tr id=${i}></tr>`;
                    for (let j=0; j<eqLen; j++){
                        document.getElementById(i).innerHTML+=`<td id=${i}${j}></td>`;
                        cells.push(`${i}${j}`)
                    }
                }
                for (let i of cells){
                    document.getElementById(i).addEventListener("click", e=>click(i));
                }
                click(selectedCell)
            }

            function click(id){
                if (gameOver){return -1;}
                if (id[0]!=currentAttempt-1){return -1;}
                let lightblue = "rgb(240, 248, 255)";
                let lightgray = "rgb(215, 223, 230)";
                let darkgray = "rgb(185, 190, 195)";
                selectedCell = id;
                for (let i in cells){
                    if (cells[i][0]>=currentAttempt-1){
                        document.getElementById(cells[i]).style.backgroundColor=lightblue;
                    }
                }
                for (let i=0; i<eqLen; i++){
                    document.getElementById(`${id[0]}${i}`).style.backgroundColor=lightgray;
                }
                document.getElementById(id).style.backgroundColor=darkgray;
            }

            function set(input){
                if (selectedCell == "" ){
                    return -1;
                } else if (typeof(input)=="number") {
                    document.getElementById(selectedCell).innerHTML = input;
                } else if (typeof(input)=="string") {
                    if (input=="enter"){
                        submit();
                        return -1;
                    } else if (input=="del"){
                        if (document.getElementById(selectedCell).innerHTML=="" && Number(selectedCell[1])>0){
                            document.getElementById(`${selectedCell[0]}${Number(selectedCell[1])-1}`).innerHTML = "";
                            click(`${selectedCell[0]}${Number(selectedCell[1])-1}`);
                            return -1;
                        } else {
                            document.getElementById(selectedCell).innerHTML = "";
                            return -1;
                        }
                    } else {
                        document.getElementById(selectedCell).innerHTML = input;
                    }
                }
                
                if (Number(selectedCell[1])<eqLen-1){
                    click(`${selectedCell[0]}${Number(selectedCell[1])+1}`);
                } else {
                    click(selectedCell);
                }
            }

            function submit(){
                let clrCorrect="#5fd4b6"; //#3d8875
                let clrPosition="#a60c70"; //#800a57
                let clrWrong="#606060"; //#161802
                let ans = ""
                for (let i=0; i<eqLen; i++){
                    ans += document.getElementById(`${currentAttempt-1}${i}`).innerHTML
                }
                if (ans.indexOf("=")==-1){console.log("Invalid");return -1;}
                if (ans.length!=eqLen){console.log("Invalid");return -1;}
                try {
                    if (eval(ans.split("=")[0]) != eval(ans.split("=")[1])){
                        console.log("Invalid");return -1;
                    }
                } catch {
                    console.log("Invalid");return -1;
                }
                console.log("Valid");
                if (ans==possibleAnswers[currentAnswerId]){
                    console.log("Correct");
                    for (let i=0; i<eqLen; i++){
                        document.getElementById(`${currentAttempt-1}${i}`).style.backgroundColor = clrCorrect;
                        document.getElementById(document.getElementById(`${currentAttempt-1}${i}`).innerHTML).style.backgroundColor = clrCorrect;
                    }
                    gameOver = true;
                    return -1;
                } else {
                    console.log("Incorrect")
                    let code = ""
                    let tempCode = [];
                    let answer = possibleAnswers[currentAnswerId];
                    let valCount = {"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"+":0,"-":0,"*":0,"/":0,"=":0}
                    for (let i in ans){
                        if (ans[i]==answer[i]){
                            tempCode.push("1");
                            valCount[ans[i]]+=1
                        } else {
                            tempCode.push("0");
                        }
                    }
                    for (let i in tempCode){
                        if (answer.indexOf(ans[i])>-1 && tempCode[i]!=1){
                            let n = answer.split("").toSorted().lastIndexOf(ans[i]) - answer.split("").toSorted().indexOf(ans[i])+1;
                            if (valCount[ans[i]]<n){
                                valCount[ans[i]]+=1;
                                code += "2";
                            } else {
                                code += tempCode[i];
                            }
                        } else {
                            code += tempCode[i];
                        }
                    }
                    for (let i in code){
                        if (code[i]==1){
                            document.getElementById(`${currentAttempt-1}${i}`).style.backgroundColor = clrCorrect;
                            document.getElementById("in"+document.getElementById(`${currentAttempt-1}${i}`).innerHTML).style.backgroundColor = clrCorrect;
                        }
                        if (code[i]==2){
                            document.getElementById(`${currentAttempt-1}${i}`).style.backgroundColor = clrPosition;
                            //if already have correct, don't change input button color
                            if (document.getElementById("in"+document.getElementById(`${currentAttempt-1}${i}`).innerHTML).style.backgroundColor!=clrCorrect){
                                document.getElementById("in"+document.getElementById(`${currentAttempt-1}${i}`).innerHTML).style.backgroundColor = clrPosition;
                            }
                        }
                        if (code[i]==0){
                            document.getElementById(`${currentAttempt-1}${i}`).style.backgroundColor = clrWrong;
                            //if already have correct or position, don't change input button color
                            if (document.getElementById("in"+document.getElementById(`${currentAttempt-1}${i}`).innerHTML).style.backgroundColor!=clrCorrect && document.getElementById("in"+document.getElementById(`${currentAttempt-1}${i}`).innerHTML).style.backgroundColor!=clrPosition){
                                document.getElementById("in"+document.getElementById(`${currentAttempt-1}${i}`).innerHTML).style.backgroundColor = clrWrong;
                            }
                        }
                    }
                }
                currentAttempt+=1;
                if (currentAttempt>attempts){
                    console.log("Game Over");
                    return -1;
                }
                click(`${currentAttempt-1}0`)
            }

            function keyInput(){
                if (gameOver){
                    if (event.key==" "){
                        gameOver = false;
                        setup(attempts);
                    }
                } else {
                    if (event.repeat==false){
                        switch (event.key){
                            //case "ArrowUp":
                            //if (Number(selectedCell[0])>0){
                            //    click(`${Number(selectedCell[0])-1}${selectedCell[1]}`);
                            //}
                            //break;
                            //case "ArrowDown":
                            //if (Number(selectedCell[0])<attempts-1){
                            //    click(`${Number(selectedCell[0])+1}${selectedCell[1]}`);
                            //}
                            //break;
                            case "Backspace":
                                set("del");
                            break;
                            case "Delete":
                                set("del");
                            break;
                            case "Enter":
                                set("enter");
                            break;
                        }
                        if ("1234567890+-*/=".split("").indexOf(event.key)>=0){
                            set(event.key);
                        }
                    }
                    switch (event.key){
                        case "ArrowRight":
                        if (Number(selectedCell[1])<eqLen-1){
                            click(`${selectedCell[0]}${Number(selectedCell[1])+1}`);
                        }
                        break;
                        case "ArrowLeft":
                        if (Number(selectedCell[1])>0){
                            click(`${selectedCell[0]}${Number(selectedCell[1])-1}`);
                        }
                        break;
                    }
                }
            }
        </script>
    </head>
    <body onload="pageLoad()" onkeydown="keyInput(event)">
        <button id="reset" onclick="setup()" tabindex="0">Load</button>
        <br>
        <table id="board"></table>
        <table id="inputs">
            <tr>
                <td style="background-color:rgb(240, 248, 255);" id="in1" onclick="set(1)">1</td>
                <td style="background-color:rgb(240, 248, 255);" id="in2" onclick="set(2)">2</td>
                <td style="background-color:rgb(240, 248, 255);" id="in3" onclick="set(3)">3</td>
                <td style="background-color:rgb(240, 248, 255);" id="in4" onclick="set(4)">4</td>
                <td style="background-color:rgb(240, 248, 255);" id="in5" onclick="set(5)">5</td>
                <td style="background-color:rgb(240, 248, 255);" id="in6" onclick="set(6)">6</td>
                <td style="background-color:rgb(240, 248, 255);" id="in7" onclick="set(7)">7</td>
                <td style="background-color:rgb(240, 248, 255);" id="in8" onclick="set(8)">8</td>
                <td style="background-color:rgb(240, 248, 255);" id="in9" onclick="set(9)">9</td>
                <td style="background-color:rgb(240, 248, 255);" id="in0" onclick="set(0)">0</td>
            </tr>
            <tr>
                <td style="background-color:rgb(240, 248, 255);" id="in+" onclick="set('+')">+</td>
                <td style="background-color:rgb(240, 248, 255);" id="in-" onclick="set('-')">-</td>
                <td style="background-color:rgb(240, 248, 255);" id="in*" onclick="set('*')">*</td>
                <td style="background-color:rgb(240, 248, 255);" id="in/" onclick="set('/')">/</td>
                <td style="background-color:rgb(240, 248, 255);" id="in=" onclick="set('=')">=</td>
                <td onclick="set('enter')" colspan="3">Enter</td>
                <td onclick="set('del')" colspan="2">Del</td>
            </tr>
        </table>
        <p></p>
    </body>
</html>