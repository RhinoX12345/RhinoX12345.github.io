<!DOCTYPE html>
<html>
    <head>
        <title>Math Battleships</title>
        <style>
            #visible {
                position: absolute;
            }

            #background {
                position: fixed;
                top: 0px;
                left: 0px;
                margin: 0px;
                border: 0px;
                height: 100vh;
                width: 100vw;
            }

            tr {
                height: 40px;
                margin: 0px;
                padding: 0px;
                border-spacing: 0px;
            }

            td {
                background-color: rgb(255, 255, 255);
                height: 40px;
                width: 40px;
                margin: 0px;
                padding: 0px 0px 0px 0px;
                padding-block: 0px;
                padding-inline: 0px;
                text-align: center;
            }

            p {
                margin: 0;
            }

            .button {
                background-color: rgb(220, 220, 220);
                height: 40px;
                width: 40px;
                padding: 0px 0px 0px 0px;
                padding-block: 0px;
                padding-inline: 0px;
                opacity: 95%;
            }

            .button:hover {
                opacity: 70%;
            }

            #table1 {
                position: absolute;
                left: 17%;
                top: 10vh;
                border-collapse: collapse;
            }

            #table2 {
                position: absolute;
                right: 17%;
                top: 10vh;
                border-collapse: collapse;
            }

            #coord {
                background-color: white;
                text-align: center;
            }
        </style>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
        <script type="module" src="https://pyscript.net/snapshots/2023.09.1.RC1/core.js"></script>
        <script>
            async function main() {
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");
                await micropip.install("random");
                await micropip.install("time");
                await pip3.install("javascript");
            }
            let status = "pregame";
            const cells = [
                'A1','A2','A3','A4','A5','A6','A7','A8',
                'B1','B2','B3','B4','B5','B6','B7','B8',
                'C1','C2','C3','C4','C5','C6','C7','C8',
                'D1','D2','D3','D4','D5','D6','D7','D8',
                'E1','E2','E3','E4','E5','E6','E7','E8',
                'F1','F2','F3','F4','F5','F6','F7','F8',
                'G1','G2','G3','G4','G5','G6','G7','G8',
                'H1','H2','H3','H4','H5','H6','H7','H8'];
            const rowList = {
                "A":['A1','A2','A3','A4','A5','A6','A7','A8'],
                "B":['B1','B2','B3','B4','B5','B6','B7','B8'],
                "C":['C1','C2','C3','C4','C5','C6','C7','C8'],
                "D":['D1','D2','D3','D4','D5','D6','D7','D8'],
                "E":['E1','E2','E3','E4','E5','E6','E7','E8'],
                "F":['F1','F2','F3','F4','F5','F6','F7','F8'],
                "G":['G1','G2','G3','G4','G5','G6','G7','G8'],
                "H":['H1','H2','H3','H4','H5','H6','H7','H8']};
            const colList = {
                "1":['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1', 'H1'],
                "2":['A2', 'B2', 'C2', 'D2', 'E2', 'F2', 'G2', 'H2'],
                "3":['A3', 'B3', 'C3', 'D3', 'E3', 'F3', 'G3', 'H3'],
                "4":['A4', 'B4', 'C4', 'D4', 'E4', 'F4', 'G4', 'H4'],
                "5":['A5', 'B5', 'C5', 'D5', 'E5', 'F5', 'G5', 'H5'],
                "6":['A6', 'B6', 'C6', 'D6', 'E6', 'F6', 'G6', 'H6'],
                "7":['A7', 'B7', 'C7', 'D7', 'E7', 'F7', 'G7', 'H7'],
                "8":['A8', 'B8', 'C8', 'D8', 'E8', 'F8', 'G8', 'H8']};
            const hintList = [
                "placeholder 1/1",
                "placeholder 2/2",
                "placeholder 3/3"];
            let playerPos = [], tempselect = [], pcells = [], botPos = {}, botPosList = [], boatlength = [], lengthCopy = [], correctPos = "", botTargetted = [], playerTargetted = [];
            for (i in cells){
                pcells.push("P"+cells[i]);
            }
            setInterval(loop, 100);
            function loop(){
                check1 = document.getElementById("bot").innerHTML;
                check2 = document.getElementById("boatlength").innerHTML;
                if(status == "pregame"){
                    let msg = check1.split("/");
                    botPos = msg[0];
                    botPosList = msg[1];
                    botPosList = botPosList.replaceAll(" ","").replaceAll("[","").replaceAll("]","").replaceAll("\'","")
                    botPosList = botPosList.split(",");
                    boatlength = check2.split("/");
                    if(botPos != "" && botPosList != undefined && boatlength != []){
                        status = "setup";
                    }
                    lengthCopy = [...boatlength];
                }
                if(status == "setup"){
                    document.getElementById("instruct").innerHTML = "Please input " + lengthCopy.length + " boats of length(s): " + lengthCopy;
                }
                if(status == "hint"){
                    document.getElementById("instruct").innerHTML = "Input Row or Column below to recieve a hint";
                }
                if(status == "target"){
                    document.getElementById("instruct").innerHTML = "Click on a position on the target board to shoot";
                }
                if(status == "hint" || status == "target"){
                    if (botPosList.length == 0){
                        if(confirm("You Win!\nClick OK to start a New Game")){
                            reset("comp")
                        }
                        status = "end"
                    } else if (playerPos.length == 0){
                        if(confirm("You Lost\nClick OK to start a New Game")){
                            reset("comp")
                        }
                        status = "end"
                    }
                }
                if(status == "end"){
                    document.getElementById("instruct").innerHTML = "Game Over"
                }
            }

            //Player Position Input
            function positionCheck(position, length, current){
                if (position.length != length){
                    document.getElementById("feedback").innerHTML = "Incorrect number of positions";
                    console.log("Incorrect number of positions")
                    return false
                }
                for (i in position){
                    if (pcells.includes(position[i]) == false){
                        document.getElementById("feedback").innerHTML = "Invalid input";
                        console.log("Invalid input")
                        return false
                    }
                }
                let dump = [...position];
                for (i in position){
                    if (current.includes(position[i])==true){
                        document.getElementById("feedback").innerHTML = "Duplicate input";
                        console.log("Duplicate input")
                        return false
                    }
                    dump.splice(dump.indexOf(position[i]), 1)
                    if (dump.includes(position[i])==true){
                        document.getElementById("feedback").innerHTML = "Duplicate input";
                        console.log("Duplicate input")
                        return false
                    }
                }
                if (length > 1){
                    let pos1 = position[0]
                    let pos2 = position[1]
                    if (rowList[pos1[1]].includes(pos2)==true){
                        console.log("horizontal")
                        for (i in position){
                            check = (pcells.indexOf(postion[i]) - pcells.indexOf(pos1)) == (position.indexOf(pos1) + i)
                            if (check==true){
                                continue
                            }else{
                                document.getElementById("feedback").innerHTML = "Invalid position";
                                return false
                            }
                        }
                    }else if (colList[pos1[2]].includes(pos2)==true){
                        console.log("vertical")
                        for (i in position){
                            check = (pcells.indexOf(postion[i]) - pcells.indexOf(pos1)) == (position.indexOf(pos1) + i*8)
                            if (check==true){
                                continue
                            }else{
                                document.getElementById("feedback").innerHTML = "Invalid position";
                                return false
                            }
                        }
                    }
                }
                document.getElementById("feedback").innerHTML = "Valid position"
                return true
            }
            function pset(id) {
                document.getElementById("feedback").innerHTML = "";
                if (status == "setup" && tempselect.length < boatlength[0]) {
                    pset1(id);
                }
                if (status == "setup" && tempselect.length == boatlength[0]){
                    let temp = [...tempselect];
                    test = positionCheck(temp, boatlength[0], playerPos);
                    if (test == true){
                        boatlength.splice(0, 1);
                        for (i in tempselect){
                            playerPos.push(tempselect[i]);
                        }
                        tempselect = [];
                    } else {
                        while (tempselect.length > 0){
                            document.getElementById(tempselect[i]).style.backgroundColor = "rgb(220, 220, 220)";
                            tempselect.splice(0, 1);
                        }
                    }
                    if (boatlength.length == 0){
                        status = "hint"
                    }
                }
            }
            function pset1(id){
                element = document.getElementById(id);
                bgcolor = window.getComputedStyle(element).backgroundColor;
                if (bgcolor == "rgb(220, 220, 220)") {
                    element.style.backgroundColor = "rgb(144, 238, 144)";
                    tempselect.push(id);
                } else if (bgcolor == "rgb(144, 238, 144)") {
                    element.style.backgroundColor = "rgb(220, 220, 220)";
                    let d = tempselect.indexOf(id);
                    tempselect.splice(d, 1);
                }
            }
            
            //Hint
            function enter(event){
                if (status != "hint"){
                    console.log(botPosList)
                    return;
                }
                let x = event.key;
                if (x == "Enter"){
                    hintput = document.getElementById("in1").value;
                    document.getElementById("in1").value = "";
                    hintput = hintput.toLowerCase();
                    if (hintput == "row"){
                        hint("row")
                    } else if (hintput == "column"){
                        hint("col")
                    } else {
                        document.getElementById("in1").value = "";
                        document.getElementById("feedback").innerHTML = "Invalid input";
                    }
                }
                
            }
            function hint(type){
                correctPos = botPosList[Math.floor(Math.random()*botPosList.length)];
                console.log(correctPos)
                dump = hintList[Math.floor(Math.random()*hintList.length)]
                dump = dump.split("/")
                question = dump[0]
                ans = dump[1]
                if (prompt(question)==ans){
                    document.getElementById("feedback").innerHTML = "Correct!"
                    if (type=="row"){
                        document.getElementById("hint").innerHTML = correctPos[0]
                    } else if (type=="col"){
                        document.getElementById("hint").innerHTML = correctPos[1]
                    }
                } else {
                    document.getElementById("feedback").innerHTML = "Incorrect"
                }
                status = "target";
            }

            //Target
            function set(id) {
                element = document.getElementById(id);
                let id1 = id.slice(1,3);
                if (status == "target") {
                    if (playerPos.includes(id)==true){
                        document.getElementById("feedback").innerHTML = "Already previously selected"
                        return //fix: make it so it doesn't let you click a square again
                    }
                    if (botPosList.includes(id1)) {
                        element.style.backgroundColor = "rgb(200, 0, 0)";
                        document.getElementById("feedback").innerHTML = "Hit";
                        botPosList.splice(botPosList.indexOf(id1), 1)
                    } else {
                        element.style.backgroundColor = "rgb(144, 238, 144)";
                        document.getElementById("feedback").innerHTML = "Miss";
                    }
                    playerTargetted.push(id1)
                    setTimeout(bot, 1000)
                    status = "hint"
                }
            }
            function bot(){
                let botTarget = cells[Math.floor(Math.random()*64)]
                while (botTargetted.includes(botTarget)){
                    botTarget = cells[Math.floor(Math.random()*64)]
                }
                botTargetted.push(botTarget)
                document.getElementById("P"+botTarget).style.backgroundColor = "rgb(200, 0, 0)";
                if (playerPos.includes("P"+botTarget)){
                    playerPos.splice(playerPos.indexOf("P"+botTarget), 1)
                    document.getElementById("P"+botTarget).innerHTML = "X";
                }
                
            }
            
            //Reset
            function skip(){
                status = "target";

            }
            function reset(key="t"){
                if (key == "comp"){
                    location.reload()
                } else {
                    if(confirm("Do you want to reset?")){
                        location.reload()
                    }
                }
            }
        </script>
        <py-config>
            packages= ["micropip"]
        </py-config>
        <script type="py" src="Battleship_NoUser.py"></script>
    </head>
    <body>
        <img src="background.png" id="background">
        <div hidden>
            <p id="bot"></p>
            <p id="boatlength"></p>
        </div>
        <div id="visible">
            <p id="instruct">Placeholder</p>
            <p id="feedback"></p>
            <p id="hint"></p>
            <br>
            <input id="in1" onkeypress="enter(event)" placeholder="Hint (Row/Column)">
            <br><br>
            <button onclick="skip()">Skip</button>
            <button onclick="reset()">Reset</button>
        </div>
        <table id="table1" border="1px">
            <tr height="40px">
                <th colspan="9">
                    <p align="center">Player Position</p>
                </th>
            </tr>
            <tr>
                <td id="coord"></td>
                <td id="coord">1</td>
                <td id="coord">2</td>
                <td id="coord">3</td>
                <td id="coord">4</td>
                <td id="coord">5</td>
                <td id="coord">6</td>
                <td id="coord">7</td>
                <td id="coord">8</td>
            </tr>
            <tr>
                <td id="coord">A</td>
                <td class="button" id="PA1" onclick="pset(id)"> </td>
                <td class="button" id="PA2" onclick="pset(id)"> </td>
                <td class="button" id="PA3" onclick="pset(id)"> </td>
                <td class="button" id="PA4" onclick="pset(id)"> </td>
                <td class="button" id="PA5" onclick="pset(id)"> </td>
                <td class="button" id="PA6" onclick="pset(id)"> </td>
                <td class="button" id="PA7" onclick="pset(id)"> </td>
                <td class="button" id="PA8" onclick="pset(id)"> </td>
            </tr>
            <tr>
                <td id="coord">B</td>
                <td class="button" id="PB1" onclick="pset(id)"></td>
                <td class="button" id="PB2" onclick="pset(id)"></td>
                <td class="button" id="PB3" onclick="pset(id)"></td>
                <td class="button" id="PB4" onclick="pset(id)"></td>
                <td class="button" id="PB5" onclick="pset(id)"></td>
                <td class="button" id="PB6" onclick="pset(id)"></td>
                <td class="button" id="PB7" onclick="pset(id)"></td>
                <td class="button" id="PB8" onclick="pset(id)"></td>
            </tr>
            <tr>
                <td id="coord">C</td>
                <td class="button" id="PC1" onclick="pset(id)"></td>
                <td class="button" id="PC2" onclick="pset(id)"></td>
                <td class="button" id="PC3" onclick="pset(id)"></td>
                <td class="button" id="PC4" onclick="pset(id)"></td>
                <td class="button" id="PC5" onclick="pset(id)"></td>
                <td class="button" id="PC6" onclick="pset(id)"></td>
                <td class="button" id="PC7" onclick="pset(id)"></td>
                <td class="button" id="PC8" onclick="pset(id)"></td>
            </tr>
            <tr>
                <td id="coord">D</td>
                <td class="button" id="PD1" onclick="pset(id)"></td>
                <td class="button" id="PD2" onclick="pset(id)"></td>
                <td class="button" id="PD3" onclick="pset(id)"></td>
                <td class="button" id="PD4" onclick="pset(id)"></td>
                <td class="button" id="PD5" onclick="pset(id)"></td>
                <td class="button" id="PD6" onclick="pset(id)"></td>
                <td class="button" id="PD7" onclick="pset(id)"></td>
                <td class="button" id="PD8" onclick="pset(id)"></td>
            </tr>
            <tr>
                <td id="coord">E</td>
                <td class="button" id="PE1" onclick="pset(id)"></td>
                <td class="button" id="PE2" onclick="pset(id)"></td>
                <td class="button" id="PE3" onclick="pset(id)"></td>
                <td class="button" id="PE4" onclick="pset(id)"></td>
                <td class="button" id="PE5" onclick="pset(id)"></td>
                <td class="button" id="PE6" onclick="pset(id)"></td>
                <td class="button" id="PE7" onclick="pset(id)"></td>
                <td class="button" id="PE8" onclick="pset(id)"></td>
            </tr>
            <tr>
                <td id="coord">F</td>
                <td class="button" id="PF1" onclick="pset(id)"></td>
                <td class="button" id="PF2" onclick="pset(id)"></td>
                <td class="button" id="PF3" onclick="pset(id)"></td>
                <td class="button" id="PF4" onclick="pset(id)"></td>
                <td class="button" id="PF5" onclick="pset(id)"></td>
                <td class="button" id="PF6" onclick="pset(id)"></td>
                <td class="button" id="PF7" onclick="pset(id)"></td>
                <td class="button" id="PF8" onclick="pset(id)"></td>
            </tr>
            <tr>
                <td id="coord">G</td>
                <td class="button" id="PG1" onclick="pset(id)"></td>
                <td class="button" id="PG2" onclick="pset(id)"></td>
                <td class="button" id="PG3" onclick="pset(id)"></td>
                <td class="button" id="PG4" onclick="pset(id)"></td>
                <td class="button" id="PG5" onclick="pset(id)"></td>
                <td class="button" id="PG6" onclick="pset(id)"></td>
                <td class="button" id="PG7" onclick="pset(id)"></td>
                <td class="button" id="PG8" onclick="pset(id)"></td>
            </tr>
            <tr>
                <td id="coord">H</td>
                <td class="button" id="PH1" onclick="pset(id)"></td>
                <td class="button" id="PH2" onclick="pset(id)"></td>
                <td class="button" id="PH3" onclick="pset(id)"></td>
                <td class="button" id="PH4" onclick="pset(id)"></td>
                <td class="button" id="PH5" onclick="pset(id)"></td>
                <td class="button" id="PH6" onclick="pset(id)"></td>
                <td class="button" id="PH7" onclick="pset(id)"></td>
                <td class="button" id="PH8" onclick="pset(id)"></td>
            </tr>
        </table>
        <table id="table2" border="1px">
            <tr height="40px">
                <th colspan="9">
                    <p align="center">Target Position</p>
                </th>
            </tr>
            <tr>
                <td id="coord"></td>
                <td id="coord">1</td>
                <td id="coord">2</td>
                <td id="coord">3</td>
                <td id="coord">4</td>
                <td id="coord">5</td>
                <td id="coord">6</td>
                <td id="coord">7</td>
                <td id="coord">8</td>
            </tr>
            <tr>
                <td id="coord">A</td>
                <td class="button" id="RA1" onclick="set(id)"></td>
                <td class="button" id="RA2" onclick="set(id)"></td>
                <td class="button" id="RA3" onclick="set(id)"></td>
                <td class="button" id="RA4" onclick="set(id)"></td>
                <td class="button" id="RA5" onclick="set(id)"></td>
                <td class="button" id="RA6" onclick="set(id)"></td>
                <td class="button" id="RA7" onclick="set(id)"></td>
                <td class="button" id="RA8" onclick="set(id)"></td>
            </tr>
            <tr>
                <td id="coord">B</td>
                <td class="button" id="RB1" onclick="set(id)"></td>
                <td class="button" id="RB2" onclick="set(id)"></td>
                <td class="button" id="RB3" onclick="set(id)"></td>
                <td class="button" id="RB4" onclick="set(id)"></td>
                <td class="button" id="RB5" onclick="set(id)"></td>
                <td class="button" id="RB6" onclick="set(id)"></td>
                <td class="button" id="RB7" onclick="set(id)"></td>
                <td class="button" id="RB8" onclick="set(id)"></td>
            </tr>
            <tr>
                <td id="coord">C</td>
                <td class="button" id="RC1" onclick="set(id)"></td>
                <td class="button" id="RC2" onclick="set(id)"></td>
                <td class="button" id="RC3" onclick="set(id)"></td>
                <td class="button" id="RC4" onclick="set(id)"></td>
                <td class="button" id="RC5" onclick="set(id)"></td>
                <td class="button" id="RC6" onclick="set(id)"></td>
                <td class="button" id="RC7" onclick="set(id)"></td>
                <td class="button" id="RC8" onclick="set(id)"></td>
            </tr>
            <tr>
                <td id="coord">D</td>
                <td class="button" id="RD1" onclick="set(id)"></td>
                <td class="button" id="RD2" onclick="set(id)"></td>
                <td class="button" id="RD3" onclick="set(id)"></td>
                <td class="button" id="RD4" onclick="set(id)"></td>
                <td class="button" id="RD5" onclick="set(id)"></td>
                <td class="button" id="RD6" onclick="set(id)"></td>
                <td class="button" id="RD7" onclick="set(id)"></td>
                <td class="button" id="RD8" onclick="set(id)"></td>
            </tr>
            <tr>
                <td id="coord">E</td>
                <td class="button" id="RE1" onclick="set(id)"></td>
                <td class="button" id="RE2" onclick="set(id)"></td>
                <td class="button" id="RE3" onclick="set(id)"></td>
                <td class="button" id="RE4" onclick="set(id)"></td>
                <td class="button" id="RE5" onclick="set(id)"></td>
                <td class="button" id="RE6" onclick="set(id)"></td>
                <td class="button" id="RE7" onclick="set(id)"></td>
                <td class="button" id="RE8" onclick="set(id)"></td>
            </tr>
            <tr>
                <td id="coord">F</td>
                <td class="button" id="RF1" onclick="set(id)"></td>
                <td class="button" id="RF2" onclick="set(id)"></td>
                <td class="button" id="RF3" onclick="set(id)"></td>
                <td class="button" id="RF4" onclick="set(id)"></td>
                <td class="button" id="RF5" onclick="set(id)"></td>
                <td class="button" id="RF6" onclick="set(id)"></td>
                <td class="button" id="RF7" onclick="set(id)"></td>
                <td class="button" id="RF8" onclick="set(id)"></td>
            </tr>
            <tr>
                <td id="coord">G</td>
                <td class="button" id="RG1" onclick="set(id)"></td>
                <td class="button" id="RG2" onclick="set(id)"></td>
                <td class="button" id="RG3" onclick="set(id)"></td>
                <td class="button" id="RG4" onclick="set(id)"></td>
                <td class="button" id="RG5" onclick="set(id)"></td>
                <td class="button" id="RG6" onclick="set(id)"></td>
                <td class="button" id="RG7" onclick="set(id)"></td>
                <td class="button" id="RG8" onclick="set(id)"></td>
            </tr>
            <tr>
                <td id="coord">H</td>
                <td class="button" id="RH1" onclick="set(id)"></td>
                <td class="button" id="RH2" onclick="set(id)"></td>
                <td class="button" id="RH3" onclick="set(id)"></td>
                <td class="button" id="RH4" onclick="set(id)"></td>
                <td class="button" id="RH5" onclick="set(id)"></td>
                <td class="button" id="RH6" onclick="set(id)"></td>
                <td class="button" id="RH7" onclick="set(id)"></td>
                <td class="button" id="RH8" onclick="set(id)"></td>
            </tr>
        </table>
    </body>
</html>